# Seamless `AppLocalizations` OTA Plan

## Goal
Make `rerune_flutter_ota` feel invisible in existing Flutter `gen-l10n` apps so developers keep using:

`Text(AppLocalizations.of(context)!.helloWorld)`

while translations update over-the-air.

## Product Direction (decided)
- Target existing `gen-l10n` apps first.
- Major redesign is allowed.
- A one-time codegen step is acceptable.

## Recommended Architecture
1. **Overlay, not replacement**
   - Keep Flutter-generated `AppLocalizations` API as the canonical typed surface.
   - Add OTA as a runtime overlay that only replaces message values.

2. **Generated typed proxy (required for true seamlessness)**
   - Generate an app-specific proxy class that matches generated getters/methods.
   - Each generated accessor resolves as: OTA value (if present and valid) -> fallback to original generated value.
   - This preserves existing UI callsites unchanged.

3. **Delegate wrapping strategy**
   - Provide a generated OTA-aware `LocalizationsDelegate<AppLocalizations>` that wraps/uses the app's generated delegate.
   - Keep support for standard `localizationsDelegates` and `supportedLocales` patterns.

4. **Controller remains transport/cache core**
   - Reuse current manifest/ARB fetch, checksum, cache, periodic update logic.
   - Expose typed-resolution helpers for proxy/delegate use.

## Implementation Plan

### Phase 1 - Refactor runtime core for typed overlay
- Update `lib/src/controller/ota_localization_controller.dart`
  - Add public APIs for keyed lookup + formatted lookup by locale (for generated proxy consumption).
  - Improve locale normalization/fallback chain (`language_script_region -> language_region -> language`).
  - Keep network/cache/update logic intact.
- Update `lib/src/utils/arb_utils.dart`
  - Preserve robust parsing behavior for OTA values and format-safe fallbacks.
- Update `lib/src/utils/locale_utils.dart`
  - Add canonical locale-key helpers used consistently by controller/proxy/delegate.

### Phase 2 - Introduce new typed integration runtime
- Add new runtime files (names can be finalized during implementation):
  - `lib/src/typed/ota_message_resolver.dart`
  - `lib/src/typed/typed_ota_localizations_delegate.dart`
  - `lib/src/widget/ota_localizations_scope.dart` (listens to revision and triggers rebuilds)
- Update `lib/rerune_flutter_ota.dart`
  - Export new typed APIs and setup entry points.

### Phase 3 - Add code generation pipeline
- Add codegen infrastructure:
  - `build.yaml`
  - `lib/src/codegen/annotations.dart`
  - `lib/src/codegen/typed_proxy_generator.dart`
  - `lib/builder.dart`
- Generate, in app code, OTA wrappers around generated localizations (example output file: `app_localizations_ota.g.dart`).
- Support common generated signatures:
  - Getter messages
  - Methods with placeholders
  - ICU plural/select methods

### Phase 4 - Redesign public onboarding around `gen-l10n`
- Update `README.md`
  - Put `gen-l10n` seamless flow first.
  - Include one-time generator command and minimal wiring steps.
  - Update integration documentation to always use Rerune API host (`https://rerune.io/api`) and remove `api.example.com` placeholders from setup snippets.
  - Keep old key-based API in legacy/migration section.
- Update example app to a real `gen-l10n` flow:
  - add `example/l10n.yaml`
  - use generated `AppLocalizations` in widgets
  - wire generated OTA-aware delegate/supported locales

### Phase 4.1 - Enforce default API host in SDK setup
- Update `lib/src/controller/ota_localization_controller.dart`
  - Hardcode the API host to `https://rerune.io/api` for manifest + ARB endpoints.
  - Remove app-facing `baseUrl` configuration from integration flow so setup is fixed to Rerune host.
- Update public docs and examples so initialization no longer shows:
  - `baseUrl: Uri.parse('https://api.example.com')`
  - and instead uses Rerune host behavior by default.

### Phase 5 - API migration and compatibility policy
- Deprecate legacy key-based surface:
  - `lib/src/localizations/ota_localizations.dart`
  - `lib/src/delegate/ota_localizations_delegate.dart`
  - `lib/src/widget/ota_localization_builder.dart`
- Optionally keep legacy exports for one major cycle (or move behind a legacy import path).

## Why this matches Phrase-like DX
- Phrase's seamless DX comes from codegen + delegate integration while preserving typed `AppLocalizations` callsites.
- This plan mirrors that model: users keep existing `AppLocalizations` usage and only perform setup/wiring + one codegen step.

## Risks and Mitigations
- **ICU mismatch (placeholders/plurals/select):** fallback to generated value on format failure; emit diagnostics.
- **Locale variant mismatch (`en`, `en_US`, `pt_BR`, scripts):** centralized canonicalization + deterministic fallback chain.
- **Startup race:** show generated fallback immediately; apply OTA overlay after async initialization.
- **Web cache/storage constraints:** add graceful cache eviction and keep fallback always available.

## Critical Files to Modify
- `lib/src/controller/ota_localization_controller.dart`
- `lib/src/utils/arb_utils.dart`
- `lib/src/utils/locale_utils.dart`
- `lib/rerune_flutter_ota.dart`
- `README.md`
- `example/README.md`
- `example/lib/main.dart`
- `example/pubspec.yaml`
- `example/l10n.yaml` (new)
- `build.yaml` (new)
- `lib/src/codegen/annotations.dart` (new)
- `lib/src/codegen/typed_proxy_generator.dart` (new)
- `lib/builder.dart` (new)

## Verification Plan
1. **Unit tests**
   - Controller update decisions (etag/version/checksum/cache).
   - Locale normalization/fallback behavior.
   - Message formatting success/fallback for placeholders/plurals/select.

2. **Codegen tests**
   - Fixture generated `AppLocalizations` APIs (getters + methods + ICU).
   - Ensure generated OTA wrappers compile and preserve method signatures.

3. **Widget tests**
   - Existing widget code uses `AppLocalizations.of(context)!.helloWorld` unchanged.
   - Verify fallback on first frame and OTA override after update revision bump.

4. **Manual end-to-end checks**
   - Android/iOS/Web:
     - cold start online/offline,
     - locale switch,
     - forced OTA update,
     - checksum mismatch handling,
     - persistence across restarts.

5. **Developer experience checks**
   - Fresh app with existing `gen-l10n` can integrate with minimal steps.
   - No UI callsite migration required.
